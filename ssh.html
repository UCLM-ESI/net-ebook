

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>4. SSH &#8212; Redes 2</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'ssh';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="5. Chat UDP" href="udp_chat.html" />
    <link rel="prev" title="3. Python" href="python.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Prefacio
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="shell.html">1. Shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="paquetes.html">2. Paquetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="python.html">3. Python</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">4. SSH</a></li>
<li class="toctree-l1"><a class="reference internal" href="udp_chat.html">5. Chat UDP</a></li>
<li class="toctree-l1"><a class="reference internal" href="serializacion.html">6. Serialización</a></li>
<li class="toctree-l1"><a class="reference internal" href="raw-sockets.html">7. Sockets RAW</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/uclm-esi/net-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/uclm-esi/net-book/issues/new?title=Issue%20on%20page%20%2Fssh.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/ssh.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>SSH</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#shell-segura">4.1. Shell segura</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuracion">4.2. Configuración</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clave-publica">4.3. Clave pública</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#autenticacion-con-certificados">4.4. Autenticación con certificados</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#un-certificado-para-el-usuario">4.4.1. Un certificado para el usuario</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#copia-remota-de-ficheros-con-scp">4.5. Copia remota de ficheros con SCP</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="ssh">
<span id="chap-ssh"></span><h1><span class="section-number">4. </span>SSH<a class="headerlink" href="#ssh" title="Permalink to this heading">#</a></h1>
<p>SSH es un protocolo de aplicación que permite establecer conexiones con máquinas remotas.
Podríamos decir que es una versión mejorada del veterano <code class="docutils literal notranslate"><span class="pre">telnet</span></code> <a class="footnote-reference brackets" href="#id3" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>, pero es
mucho más que eso. SSH proporciona un canal seguro (cifrado) para ejecutar comandos,
transferir ficheros (con <code class="docutils literal notranslate"><span class="pre">scp</span></code>), redireccionar conexiones, crear túneles
que pueden transportar datos de conexiones arbitrarias o simplemente como sistema de
autenticación, y mucho más.</p>
<section id="shell-segura">
<h2><span class="section-number">4.1. </span>Shell segura<a class="headerlink" href="#shell-segura" title="Permalink to this heading">#</a></h2>
<p>Como ya indica su nombre, el uso más común de la aplicación SSH es el de «shell remota»,
es decir, un programa que permite abrir una sesión en un computador remoto y ejecutar
comandos. En este capítulo vamos a usar concretamente la aplicación OpenSSH, que en el
caso de sistemas GNU/Linux suele estar disponible como dos paquetes: <code class="docutils literal notranslate"><span class="pre">openssh-server</span></code> y
<code class="docutils literal notranslate"><span class="pre">openssh-client</span></code>. Por supuesto, existen otras muchas implementaciones para casi cualquier
SO.</p>
<p>Se trata, por supuesto, de una aplicación cliente-servidor, es decir, el servidor SSH, que
debe estar instalado en cada computador al que pretendamos acceder, siempre está a la
espera de conexiones, mientras que el cliente SSH es el que inicia la conexión.</p>
<p>Para probar SSH vamos a utilizar un contenedor docker. Para construir la imagen
docker correspondiente, descarga el repositorio <code class="docutils literal notranslate"><span class="pre">git</span></code> con el siguiente comando:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">ana@laptop:~$ </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/UCLM-ARCO/net-book-code
</pre></div>
</div>
<p>Y ejecuta el siguiente comando dentro del directorio <code class="docutils literal notranslate"><span class="pre">ssh-docker</span></code>. Esto crea la
imagen y arranca el contenedor que ejecuta el servidor SSH:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">ana@laptop:~/net-book-code/ssh-docker$ </span>docker-compose<span class="w"> </span>up<span class="w"> </span>-d
<span class="go">[...]</span>
</pre></div>
</div>
<p>En un sistema GNU/Linux utilizar SSH es muy sencillo. Basta con abrir un terminal e
indicar a través del comando <code class="docutils literal notranslate"><span class="pre">ssh</span></code> el nombre de usuario, el computador
remoto y el puerto (si es distinto del 22).</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">ana@laptop:~$ </span>ssh<span class="w"> </span>user@172.20.0.2
<span class="go">user@172.20.0.2&#39;s password:</span>
<span class="gp">user@viper:~$</span>
</pre></div>
</div>
<p>El comando <code class="docutils literal notranslate"><span class="pre">ssh</span></code> trata de establecer una conexión segura con el servidor SSH
que hay en 172.20.0.2 (el contenedor docker). Concretamente queremos acceder con la cuenta
del usuario  <code class="docutils literal notranslate"><span class="pre">user</span></code>. Este proceso pide la contraseña asociada a
ese usuario, que no se muestra al introducirla. Es nuestro caso es <code class="docutils literal notranslate"><span class="pre">secret</span></code>.</p>
</section>
<section id="configuracion">
<h2><span class="section-number">4.2. </span>Configuración<a class="headerlink" href="#configuracion" title="Permalink to this heading">#</a></h2>
<p>Para simplificar el comando de conexión se puede escribir un fichero de configuración
llamado  <code class="docutils literal notranslate"><span class="pre">~/.ssh/config</span></code> en el <strong>computador cliente</strong>. Para el caso anterior, el fichero
podría ser algo como:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Host</span> <span class="n">viper</span>
    <span class="n">hostname</span> <span class="mf">172.20.0.2</span>
    <span class="n">User</span> <span class="n">user</span>
</pre></div>
</div>
<p>Es importante señalar que este fichero debe tener permisos de lectura/escritura solo para
el usuario (<code class="docutils literal notranslate"><span class="pre">-rw-r--r--</span></code>) o será ignorado. Una vez tengas esta configuración puedes
conectar simplemente con:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">ana@laptop:~$ </span>ssh<span class="w"> </span>viper
<span class="go">user@172.20.0.2&#39;s password:</span>
</pre></div>
</div>
<p>Este modo de autenticación con usuario/clave se llama de «clave privada» porque se
asume que solamente el usuario la conoce.</p>
</section>
<section id="clave-publica">
<span id="sec-clave-publica"></span><h2><span class="section-number">4.3. </span>Clave pública<a class="headerlink" href="#clave-publica" title="Permalink to this heading">#</a></h2>
<p>Para evitar tener que escribir constantemente la clave cada vez que conectas a una misma
máquina, SSH ofrece un sistema de autenticación de «clave pública». Este sistema utiliza
un par de claves privada/pública. La clave pública se coloca en el nodo al que quieres
acceder y, de hecho, no hay ningún problema en que cualquiera la pueda leer o copiar (por
eso se llama <em>pública</em>). Sin embargo, la clave privada debe quedar custodiada por el
usuario y nunca debe ser accesible para nadie más.</p>
<p>Para generar el par de claves ejecuta el siguiente comando aceptando todos los valores por
defecto (pulsa ENTER):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">ana@laptop:~$ </span>ssh-keygen
<span class="go">Generating public/private rsa key pair.</span>
<span class="go">Enter file in which to save the key (/home/ana/.ssh/id_rsa):</span>
<span class="go">Enter passphrase (empty for no passphrase):</span>
<span class="go">Enter same passphrase again:</span>
<span class="go">Your identification has been saved in /home/ana/.ssh/id_rsa</span>
<span class="go">Your public key has been saved in /home/ana/.ssh/id_rsa.pub</span>
<span class="go">The key fingerprint is:</span>
<span class="go">SHA256:KXUrUqPxk/EPiXEBfgqK3HlSqvhphSeh6O+qm9tz1DM ana@laptop</span>
</pre></div>
</div>
<p>Esto genera dos ficheros llamados <code class="docutils literal notranslate"><span class="pre">id_rsa</span></code> (clave privada) y <code class="docutils literal notranslate"><span class="pre">id_rsa.pub</span></code> (clave pública)
en el directorio <code class="docutils literal notranslate"><span class="pre">/home/ana/.ssh/</span></code>.</p>
<p>Ahora se debe enviar la clave pública al servidor. Esto se puede hacer fácilmente con:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">ana@laptop:~$ </span>ssh-copy-id<span class="w"> </span>viper
<span class="go">user@172.20.0.2&#39;s password:</span>

<span class="go">Number of key(s) added: 1</span>

<span class="go">Now try logging into the machine, with:   &quot;ssh &#39;viper&#39;&quot;</span>
<span class="go">and check to make sure that only the key(s) you cantead were added.</span>
</pre></div>
</div>
<p>Este programa almacena la clave pública del usuario —por defecto,
<code class="docutils literal notranslate"><span class="pre">~/.ssh/id_rsa.pub</span></code>— en el fichero <code class="docutils literal notranslate"><span class="pre">~/.ssh/authorized_keys</span></code> del servidor (<code class="docutils literal notranslate"><span class="pre">viper</span></code> en
este ejemplo).</p>
<p>Y tal como indica, ahora deberíamos poder entrar en la máquina <code class="docutils literal notranslate"><span class="pre">viper</span></code> simplemente
con:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">ana@laptop:~$ </span>ssh<span class="w"> </span>viper
<span class="go">Last login: Mon Mar 14 21:07:15 2022 from 172.20.0.1</span>
<span class="gp">user@viper:~$</span>
</pre></div>
</div>
<p>Esto no solo es interesante porque ahorra al usuario tener que escribir su contraseña
constantemente. Además permite que las aplicaciones puedan automatizar tareas sin la
intervención de un usuario. Los sistemas de control de versiones (como <code class="docutils literal notranslate"><span class="pre">git</span></code>) o
sistemas de Integración o Despliegue Continuo (CI/CD) utilizan habitualmente
autenticación SSH con clave pública.</p>
<p>También es posible ejecutar un único comando en el servidor y ver la salida directamente
en el computador cliente. Simplemente hay que escribir el comando a continuación:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">ana@laptop:~$ </span>ssh<span class="w"> </span>viper<span class="w"> </span>ls<span class="w"> </span>/home/
<span class="go">user</span>
</pre></div>
</div>
</section>
<section id="autenticacion-con-certificados">
<h2><span class="section-number">4.4. </span>Autenticación con certificados<a class="headerlink" href="#autenticacion-con-certificados" title="Permalink to this heading">#</a></h2>
<p>Otra forma de autenticar usuarios es mediante certificados, una opción algo más
avanzada que la autenticación con clave pública, que hemos visto en la sección anterior.
Estos certificados son emitidos por una autoridad de certificación (CA), que firma
(con su clave privada) el par de claves (privada/pública) de los usuarios. El resultado
son certificados que permiten autenticar usuarios en hosts y viceversa.</p>
<p>La ventaja de este sistema es que el administrador de un servidor puede expedir
certificados para un número arbitrario de usuarios. Un mismo par de claves firmado por un
administrador puede otorgar derecho de acceso a múltiples servidores sin tener que
modificar su configuración.</p>
<p>Las claves de la CA se crean también con el comando <code class="docutils literal notranslate"><span class="pre">ssh-keygen</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~$ ssh-keygen -t rsa -f ca_key -P &quot;&quot; -C ca_key</span>
<span class="go">Generating public/private rsa key pair.</span>
<span class="go">Your identification has been saved in ca_key</span>
<span class="go">Your public key has been saved in ca_key.pub</span>
<span class="go">The key fingerprint is:</span>
<span class="go">SHA256:nbN+pdyB3paUUnoPe60KJbkC3flKiXCVbSIH51wQXbo ca_key</span>
</pre></div>
</div>
<p>Aunque <code class="docutils literal notranslate"><span class="pre">ssh-keygen</span></code> proporciona multitud de opciones, en este caso solamente utilizamos
algunas de ellas:</p>
<dl class="simple myst">
<dt><code class="docutils literal notranslate"><span class="pre">-t</span></code></dt><dd><p>permite indicar el algoritmo (en este caso cifrado RSA.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">-f</span></code></dt><dd><p>especifica el nombre del fichero destino.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">-P</span></code></dt><dd><p>define la contraseña (vacía en este caso).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">-C</span></code></dt><dd><p>añade un comentario que aparece al final de la clave pública.</p>
</dd>
</dl>
<p>La clave privada (<code class="docutils literal notranslate"><span class="pre">ca_key</span></code>), por supuesto, debe almacenarse de forma segura, ya que es con
la que se firma y emite los certificados. La clave pública (<code class="docutils literal notranslate"><span class="pre">ca_key.pub</span></code>) es la que se
utiliza el servidor SSH en el proceso de autenticación de los clientes.</p>
<section id="un-certificado-para-el-usuario">
<h3><span class="section-number">4.4.1. </span>Un certificado para el usuario<a class="headerlink" href="#un-certificado-para-el-usuario" title="Permalink to this heading">#</a></h3>
<p>Los certificados SSH de usuario hacen posible autenticar usuarios en un servidor
determinado. Para ilustrar cómo funcionan vamos a generar un certificado para el usuario
<code class="docutils literal notranslate"><span class="pre">user</span></code> de la máquina <code class="docutils literal notranslate"><span class="pre">viper</span></code> como lo haría su administrador. Primero creamos un par de
claves pública/privada para el usuario, con el nombre <code class="docutils literal notranslate"><span class="pre">user_key</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ssh-keygen<span class="w"> </span>-f<span class="w"> </span>user_key
</pre></div>
</div>
<p>Después, se firma la clave pública del usuario (<code class="docutils literal notranslate"><span class="pre">user_key.pub</span></code>) con la clave
privada de la CA (<code class="docutils literal notranslate"><span class="pre">ca_key</span></code>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ssh-keygen<span class="w"> </span>-s<span class="w"> </span>ca_key<span class="w"> </span>-I<span class="w"> </span>viper<span class="w"> </span>-n<span class="w"> </span>user<span class="w"> </span>user_key.pub
</pre></div>
</div>
<p>Con este comando se ha generado también el certificado <code class="docutils literal notranslate"><span class="pre">user_key-cert.pub</span></code>.</p>
<p>Las opciones que se han usado en la firma son:</p>
<dl class="simple myst">
<dt><code class="docutils literal notranslate"><span class="pre">-s</span></code></dt><dd><p>para indicar la clave con la que se quiere firmar (<em>sign</em>).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">-I</span></code></dt><dd><p>para determinar la identidad del certificado, normalmente el nombre del <em>host</em> (puede
utilizarse en el futuro para revocar un certificado, por ejemplo).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">-n</span></code></dt><dd><p>que permite definir una lista de usuarios y/o <em>hosts</em> donde el certificado es válido (en
este caso únicamente el usuario <code class="docutils literal notranslate"><span class="pre">user</span></code>.</p>
</dd>
</dl>
<p>En el servidor, es necesario almacenar la clave pública de la CA con los permisos
adecuados (644). En la máquina <code class="docutils literal notranslate"><span class="pre">viper</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@viper:/etc/ssh# </span>chmod<span class="w"> </span><span class="m">644</span><span class="w"> </span>ca_key.pub
<span class="gp">root@viper:/etc/ssh# </span>ls<span class="w"> </span>-la<span class="w"> </span>ca_key.pub
<span class="go">-rw-r--r-- 1 user user    562 Mar  3 09:13 ca_key.pub</span>
</pre></div>
</div>
<p>Para indicar que todas las claves de usuario firmadas por la CA se pueden autenticar
en el servidor, se debe añadir lo siguiente en el archivo de configuración
<code class="docutils literal notranslate"><span class="pre">/etc/ssh/sshd_config</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TrustedUserCAKeys</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">ca_key</span><span class="o">.</span><span class="n">pub</span>
</pre></div>
</div>
<p>Para que los cambios tengan efecto reiniciamos el servidor SSH (<code class="docutils literal notranslate"><span class="pre">sshd</span></code>) con:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@viper:~# </span>systemctl<span class="w"> </span>restart<span class="w"> </span>sshd
</pre></div>
</div>
<p>Con esto termina la configuración el servidor (<code class="docutils literal notranslate"><span class="pre">viper</span></code> en este ejemplo). Este proceso
lo realizar automáticamente la contrucción de la imagen docker y se puede ver en el
fichero <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code>.</p>
<p>Por otro lado, el cliente tiene que copiar su clave privada (<code class="docutils literal notranslate"><span class="pre">user_key</span></code>) y su
certificado (<code class="docutils literal notranslate"><span class="pre">user_key-cert.pub</span></code>) en su directorio
<code class="docutils literal notranslate"><span class="pre">~/.ssh/</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">ana@laptop:~$ </span>ls<span class="w"> </span>-l<span class="w"> </span>~/.ssh
<span class="go">-rw------- 1 ana    ana    2590 mar  3 09:35 user_key</span>
<span class="go">-rw-rw-r-- 1 ana    ana    2020 mar  3 09:40 user_key-cert.pub</span>
<span class="go">-rw-rw-r-- 1 ana    ana     137 mar  3 10:04 config</span>
</pre></div>
</div>
<p>Además, habrá de indicar que quiere usar esa clave a la hora de acceder a la máquina
<code class="docutils literal notranslate"><span class="pre">viper</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">ana@laptop:~$ </span>ssh<span class="w"> </span>-i<span class="w"> </span>~/.ssh/user_key<span class="w"> </span>viper
</pre></div>
</div>
<p>Para mayor comodidad, puede añadirse la clave a la configuración de <code class="docutils literal notranslate"><span class="pre">viper</span></code> en
<code class="docutils literal notranslate"><span class="pre">~/.ssh/config</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Host</span> <span class="n">viper</span>
    <span class="n">Hostname</span> <span class="n">localhost</span>
    <span class="n">Port</span> <span class="mi">2200</span>
    <span class="n">User</span> <span class="n">user</span>
    <span class="n">IdentityFile</span> <span class="o">~/.</span><span class="n">ssh</span><span class="o">/</span><span class="n">user_key</span>
</pre></div>
</div>
<p>Y con esto se podrá acceder simplemente con:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">ana@laptop:~$ </span>ssh<span class="w"> </span>viper
</pre></div>
</div>
<p>La diferencia respecto a lo explicado en la sección <a class="reference internal" href="#sec-clave-publica"><span class="std std-numref">Section 4.3</span></a>:
<a class="reference internal" href="#sec-clave-publica"><span class="std std-ref">Clave pública</span></a> es que el usuario nunca necesitó una clave textual para acceder
al servidor. De hecho, el servidor se puede configurar para que la única forma de
autenticación permitida sea mediante clave pública <a class="footnote-reference brackets" href="#id4" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>, de modo que no hay posibilidad de
usar <code class="docutils literal notranslate"><span class="pre">ssh-copy-id</span></code>. Esto se considera más seguro.</p>
</section>
</section>
<section id="copia-remota-de-ficheros-con-scp">
<h2><span class="section-number">4.5. </span>Copia remota de ficheros con SCP<a class="headerlink" href="#copia-remota-de-ficheros-con-scp" title="Permalink to this heading">#</a></h2>
<p>SCP es un protocolo de copia segura de ficheros entre computadores cualesquiera
conectados a Internet. Resulta especialmente cómodo ya que el propio servidor de
OpenSSH lo incorpora y está activado por defecto.</p>
<p>Con la configuración expricada previamente,  es tan sencillo como:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>scp<span class="w"> </span>un-fichero<span class="w"> </span>viper:
<span class="go">un-fichero                                              100%    5    16.6KB/s   00:00</span>
</pre></div>
</div>
<p>El formato básico es similar al comando <code class="docutils literal notranslate"><span class="pre">cp</span></code> estándar, es decir, se indica origen y
destino. Si alguno de los dos es remoto (que es obviamente lo normal) se debe indicar el
nombre de un nodo seguido de ‘<code class="docutils literal notranslate"><span class="pre">:</span></code>’, tal como aparece en el ejemplo anterior.</p>
<p>También es posible copiar directorios recursivamente si se utiliza la opción <code class="docutils literal notranslate"><span class="pre">-r</span></code>.</p>
<hr class="footnotes docutils" />
<aside class="footnote brackets" id="id3" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>y tremendamente inseguro.</p>
</aside>
<aside class="footnote brackets" id="id4" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">2</a><span class="fn-bracket">]</span></span>
<p><code class="docutils literal notranslate"><span class="pre">PasswordAuthentication</span> <span class="pre">no</span></code></p>
</aside>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "uclm-esi/net-book",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="python.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">3. </span>Python</p>
      </div>
    </a>
    <a class="right-next"
       href="udp_chat.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">5. </span>Chat UDP</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#shell-segura">4.1. Shell segura</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuracion">4.2. Configuración</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clave-publica">4.3. Clave pública</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#autenticacion-con-certificados">4.4. Autenticación con certificados</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#un-certificado-para-el-usuario">4.4.1. Un certificado para el usuario</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#copia-remota-de-ficheros-con-scp">4.5. Copia remota de ficheros con SCP</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            <div class="bd-footer-content__inner">
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Departamento ATC
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div></div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>